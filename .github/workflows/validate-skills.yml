name: Validate Skills
on:
  push:
    paths: ['skills/**']
  pull_request:
    paths: ['skills/**']

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate frontmatter and sections
        run: |
          failed=0
          for f in skills/*/*/SKILL.md; do
            # Check YAML frontmatter exists
            if ! head -1 "$f" | grep -q '^---$'; then
              echo "FAIL: $f missing YAML frontmatter"
              failed=1
              continue
            fi

            # Extract frontmatter
            fm=$(sed -n '1,/^---$/p' "$f" | tail -n +2 | head -n -1)

            # Check required fields
            for field in name description; do
              if ! echo "$fm" | grep -q "^${field}:"; then
                echo "FAIL: $f missing required field '$field'"
                failed=1
              fi
            done

            # Check name constraints (lowercase, hyphens, max 50 chars)
            name=$(echo "$fm" | grep '^name:' | sed 's/^name: *//')
            if ! echo "$name" | grep -qE '^[a-z][a-z0-9-]{0,49}$'; then
              echo "FAIL: $f invalid name '$name'"
              failed=1
            fi

            # Check required sections
            for section in "When to Use" "Inputs" "Procedure" "Validation" "Common Pitfalls" "Related Skills"; do
              if ! grep -q "## ${section}" "$f"; then
                echo "FAIL: $f missing section '## ${section}'"
                failed=1
              fi
            done
          done
          exit $failed

      - name: Check line counts
        run: |
          failed=0
          for f in skills/*/*/SKILL.md; do
            lines=$(wc -l < "$f")
            if [ "$lines" -gt 500 ]; then
              echo "FAIL: $f ($lines lines > 500)"
              failed=1
            fi
          done
          exit $failed

      - name: Verify registry count
        run: |
          disk_count=$(find skills -name SKILL.md | wc -l)
          reg_count=$(grep 'total_skills:' skills/_registry.yml | awk '{print $2}')
          if [ "$disk_count" != "$reg_count" ]; then
            echo "FAIL: disk=$disk_count registry=$reg_count"
            exit 1
          fi
          echo "OK: $disk_count skills on disk match registry"

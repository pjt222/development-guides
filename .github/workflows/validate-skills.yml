name: Validate Skills
on:
  push:
    paths: ['skills/**']
  pull_request:
    paths: ['skills/**']

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install skills-ref
        run: |
          pip install "git+https://github.com/agentskills/agentskills.git#subdirectory=skills-ref"
          skills-ref --version

      - name: Validate all skills
        run: |
          failed=0
          for dir in skills/*/*/; do
            if [ -f "$dir/SKILL.md" ]; then
              if ! skills-ref validate "$dir"; then
                failed=1
              fi
            fi
          done
          exit $failed

      - name: Check line counts
        run: |
          failed=0
          for f in skills/*/*/SKILL.md; do
            lines=$(wc -l < "$f")
            if [ "$lines" -gt 500 ]; then
              echo "FAIL: $f ($lines lines > 500)"
              failed=1
            fi
          done
          exit $failed

      - name: Verify registry count
        run: |
          disk_count=$(find skills -name SKILL.md | wc -l)
          reg_count=$(grep 'total_skills:' skills/_registry.yml | awk '{print $2}')
          if [ "$disk_count" != "$reg_count" ]; then
            echo "FAIL: disk=$disk_count registry=$reg_count"
            exit 1
          fi
          echo "OK: $disk_count skills on disk match registry"

#!/usr/bin/env node
/**
 * sync-palette-colors.js - Sync R-generated palette colors into js/colors.js
 *
 * Reads data/palette-colors.json (generated by generate-palette-colors.R)
 * and rewrites the PALETTES, AGENT_PALETTE_COLORS, TEAM_PALETTE_COLORS blocks in js/colors.js.
 *
 * Usage: node sync-palette-colors.js
 */

const fs = require('fs');
const path = require('path');

const PALETTE_JSON = path.join(__dirname, 'public', 'data', 'palette-colors.json');
const COLORS_JS = path.join(__dirname, 'js', 'colors.js');

// ── Read palette data ────────────────────────────────────────────────
const data = JSON.parse(fs.readFileSync(PALETTE_JSON, 'utf8'));
const paletteNames = data.meta.palettes;
const domainOrder = data.meta.domains;
const agentOrder = data.meta.agents;
const teamOrder = data.meta.teams;

// ── Generate DOMAIN_ORDER ────────────────────────────────────────────
function genDomainOrder() {
  const items = domainOrder.map(d => `  '${d}'`).join(',\n');
  return `const DOMAIN_ORDER = [\n${items},\n];`;
}

// ── Generate PALETTES object ─────────────────────────────────────────
function genPalettes() {
  const entries = [];
  for (const pal of paletteNames) {
    const domainEntries = domainOrder.map(d => {
      const hex = data.palettes[pal].domains[d] || '#ffffff';
      return `    '${d}':${' '.repeat(Math.max(1, 26 - d.length))}'${hex}'`;
    }).join(',\n');
    entries.push(`  ${pal}: {\n${domainEntries},\n  }`);
  }
  return `const PALETTES = {\n${entries.join(',\n\n')},\n};`;
}

// ── Generate AGENT_PALETTE_COLORS ────────────────────────────────────
function genAgentColors() {
  const entries = [];
  for (const pal of paletteNames) {
    const agentEntries = agentOrder.map(a => {
      const hex = data.palettes[pal].agents[a] || '#ffd700';
      return `    '${a}':${' '.repeat(Math.max(1, 30 - a.length))}'${hex}'`;
    }).join(',\n');
    entries.push(`  ${pal}: {\n${agentEntries},\n  }`);
  }
  return `const AGENT_PALETTE_COLORS = {\n${entries.join(',\n\n')},\n};`;
}

// ── Generate TEAM_PALETTE_COLORS ──────────────────────────────────────
function genTeamColors() {
  const entries = [];
  for (const pal of paletteNames) {
    const teamEntries = teamOrder.map(t => {
      const hex = data.palettes[pal].teams[t] || '#00ffcc';
      return `    '${t}':${' '.repeat(Math.max(1, 30 - t.length))}'${hex}'`;
    }).join(',\n');
    entries.push(`  ${pal}: {\n${teamEntries},\n  }`);
  }
  return `const TEAM_PALETTE_COLORS = {\n${entries.join(',\n\n')},\n};`;
}

// ── Read and patch colors.js ─────────────────────────────────────────
let src = fs.readFileSync(COLORS_JS, 'utf8');

// Replace DOMAIN_ORDER
src = src.replace(
  /const DOMAIN_ORDER = \[[\s\S]*?\];/,
  genDomainOrder()
);

// Replace PALETTES
src = src.replace(
  /const PALETTES = \{[\s\S]*?\n\};/,
  genPalettes()
);

// Replace AGENT_COLORS block with AGENT_PALETTE_COLORS
// The old block is either AGENT_COLORS or AGENT_PALETTE_COLORS
const agentBlockRegex = /\/\/ ── Agent colors[\s\S]*?(?=\nexport function getAgentColor)/;
const newAgentBlock = `// ── Per-agent per-palette colors ─────────────────────────────────
${genAgentColors()}
`;
src = src.replace(agentBlockRegex, newAgentBlock);

// Update getAgentColor to accept agentId parameter
src = src.replace(
  /export function getAgentColor\(\) \{[\s\S]*?\}/,
  `export function getAgentColor(agentId) {
  if (agentId && AGENT_PALETTE_COLORS[currentTheme]?.[agentId]) {
    return AGENT_PALETTE_COLORS[currentTheme][agentId];
  }
  // Fallback: first agent color in current palette, or gold
  const colors = AGENT_PALETTE_COLORS[currentTheme];
  if (colors) {
    const vals = Object.values(colors);
    return vals[0] || '#ffd700';
  }
  return '#ffd700';
}`
);

// Replace TEAM_PALETTE_COLORS block
const teamBlockRegex = /\/\/ ── Per-team per-palette colors[\s\S]*?(?=\nexport function getTeamColor)/;
const newTeamBlock = `// ── Per-team per-palette colors ──────────────────────────────────
${genTeamColors()}
`;
src = src.replace(teamBlockRegex, newTeamBlock);

// Update the header comment
src = src.replace(
  /\* colors\.js - Theme palette system with \d+ switchable colormaps/,
  '* colors.js - Theme palette system with 9 switchable colormaps'
);

fs.writeFileSync(COLORS_JS, src, 'utf8');

console.log(`Synced ${paletteNames.length} palettes (${domainOrder.length} domains, ${agentOrder.length} agents, ${teamOrder.length} teams) into ${COLORS_JS}`);

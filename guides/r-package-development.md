---
title: "R Package Development"
description: "Package structure, testing, CRAN submission, pkgdown deployment, and renv management"
category: infrastructure
agents: [r-developer, code-reviewer]
teams: [r-package-review]
skills: [create-r-package, write-roxygen-docs, write-testthat-tests, submit-to-cran, build-pkgdown-site, manage-renv-dependencies, setup-github-actions-ci]
---

# R Package Development

A comprehensive guide covering the full R package lifecycle: scaffolding, documentation, testing, dependency management with renv, pkgdown site deployment, CRAN submission, and CI/CD with GitHub Actions.

## When to Use This Guide

- Starting a new R package with `usethis::create_package()`
- Adding documentation, tests, or vignettes to an existing package
- Setting up or troubleshooting renv for reproducible dependencies
- Deploying a pkgdown documentation site to GitHub Pages
- Preparing a package for CRAN submission

## Prerequisites

R, RStudio, and Git must be installed and configured. For WSL-Windows hybrid environments, see [Setting Up Your Environment](setting-up-your-environment.md).

## Workflow Overview

The [r-developer](../agents/r-developer.md) agent handles day-to-day package development. For comprehensive reviews (code quality, security, documentation), invoke the [r-package-review](../teams/r-package-review.md) team, which coordinates the r-developer, code-reviewer, senior-software-developer, and security-analyst agents.

## Package Structure

```
package-name/
├── DESCRIPTION              # Package metadata
├── NAMESPACE               # Export/import directives (generated by roxygen2)
├── LICENSE / LICENSE.md    # License files
├── README.md / NEWS.md    # Overview and version history
├── R/                     # R source code
├── man/                   # Documentation (generated by roxygen2)
├── tests/testthat/        # Test suite
├── vignettes/             # Long-form documentation
├── inst/                  # Additional installed files
├── data/                  # Package data (if needed)
├── .Rbuildignore          # Files to exclude from build
├── .Rprofile              # Development session config
├── .Renviron.example      # Environment variable template
├── .Renviron              # Actual env vars (git-ignored)
├── CLAUDE.md              # AI assistant instructions
├── _pkgdown.yml           # pkgdown site configuration
├── .github/               # GitHub Actions workflows
└── renv/                  # Dependency management
    └── renv.lock
```

## Development Workflow

### Initial Setup

```r
usethis::create_package("packagename")
usethis::use_git()
usethis::use_mit_license()
usethis::use_readme_md()
usethis::use_news_md()
usethis::use_testthat()
usethis::use_github_action_check_standard()
renv::init()
```

See the [create-r-package](../skills/r-packages/create-r-package/SKILL.md) skill for the full procedure.

### Daily Development Cycle

```r
devtools::load_all()    # 1. Load functions for interactive use
# 2. Edit R source files
devtools::document()    # 3. Regenerate documentation
devtools::test()        # 4. Run tests
devtools::check()       # 5. Full package check
devtools::install()     # 6. Install and verify
```

### Feature Development

```r
usethis::use_r("feature_name")      # Create R source file
usethis::use_test("feature_name")   # Create matching test file
```

## Documentation Standards

### Function Documentation

```r
#' Brief description in one line
#'
#' More detailed description explaining what the function does,
#' why it exists, and when to use it.
#'
#' @param x Description of parameter x
#' @param y Description of parameter y
#' @return Description of what the function returns
#'
#' @examples
#' result <- function_name(x = 1, y = 2)
#' \dontrun{
#' expensive_operation()
#' }
#'
#' @export
#' @family related_functions
function_name <- function(x, y) {
  # Implementation
}
```

See the [write-roxygen-docs](../skills/r-packages/write-roxygen-docs/SKILL.md) skill for detailed patterns.

### Package-Level Documentation

Create `R/packagename-package.R`:

```r
#' @keywords internal
"_PACKAGE"

## usethis namespace: start
## usethis namespace: end
NULL
```

### Vignettes and README

```r
usethis::use_vignette("getting-started")
```

README should include: installation instructions, quick start example, links to vignettes and pkgdown site, R CMD check badge, and a clear value proposition.

## Testing Strategy

```r
# File: tests/testthat/test-feature.R
test_that("function handles basic input", {
  result <- function_name(1, 2)
  expect_equal(result, expected_value)
})

test_that("function validates input", {
  expect_error(function_name("not_a_number"), "Expected numeric")
})

test_that("function handles edge cases", {
  expect_equal(function_name(NA, 1), NA)
})

# Temporary files
test_that("function writes files correctly", {
  tmp_file <- file.path(tempdir(), "test.txt")
  function_that_writes(tmp_file)
  expect_true(file.exists(tmp_file))
})

# Mocking
test_that("function handles API calls", {
  mockery::stub(function_name, "api_call", list(data = "mocked"))
  expect_equal(function_name()$data, "mocked")
})
```

Coverage goals: >80% code coverage, all exported functions tested, error conditions and edge cases covered. Use `testthat::skip_on_cran()` for tests requiring network or long runtimes.

See the [write-testthat-tests](../skills/r-packages/write-testthat-tests/SKILL.md) skill for the full procedure.

## renv Dependency Management

### Core Commands

```r
renv::init()              # Initialize renv in project
renv::install("pkg")      # Install a package
renv::snapshot()          # Record current state to lockfile
renv::restore()           # Restore from lockfile
renv::status()            # Check sync between lockfile and library
```

See the [manage-renv-dependencies](../skills/r-packages/manage-renv-dependencies/SKILL.md) skill for detailed procedures.

### Installing GitHub Packages

Install core CRAN dependencies first, then GitHub packages, to avoid timeouts:

```r
core_packages <- c("dplyr", "tidyr", "ggplot2", "rlang", "testthat")
for (pkg in core_packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) renv::install(pkg)
}
renv::install("posit-dev/mcptools")
renv::snapshot()
```

### Conditional Loading in .Rprofile

Always guard development tool loading to prevent CI/CD failures:

```r
if (file.exists("renv/activate.R")) source("renv/activate.R")

if (requireNamespace("mcptools", quietly = TRUE)) {
  mcptools::mcp_session()
}
```

### .Rbuildignore for renv

```
^renv$
^renv\.lock$
^setup_renv\.R$
```

### Handling Package Renames

When a dependency is renamed (e.g., acquaint to mcptools), update systematically: `.Rprofile` calls, documentation references, DESCRIPTION entries, and then run `renv::install("new-source/new-name")` followed by `renv::snapshot()`.

### Diagnostics and Recovery

```r
renv::diagnostics()    # Full diagnostic report
renv::dependencies()   # Audit which packages the project uses
renv::purge()          # Clear corrupted cache
```

If renv is corrupted beyond repair: delete `renv/` and `renv.lock`, restart R, run `renv::init()`, and reinstall packages.

## pkgdown Site Deployment

### Local Preview

```r
pkgdown::build_site()     # Build locally
pkgdown::preview_site()   # Preview at localhost
```

See the [build-pkgdown-site](../skills/r-packages/build-pkgdown-site/SKILL.md) skill for the full procedure.

### _pkgdown.yml Configuration

```yaml
url: https://username.github.io/packagename/
template:
  bootstrap: 5
# IMPORTANT: Disable development mode for GitHub Pages -- it causes /dev/ subdirectory 404s
# development:
#   mode: auto
```

### Branch-Based Deployment (Recommended)

Create `.github/workflows/pkgdown-gh-pages.yaml` with steps: checkout, setup R/pandoc via `r-lib/actions`, install pkgdown + package deps, build site, and deploy `docs/` to `gh-pages` branch:

```yaml
on:
  push: { branches: [main] }
  release: { types: [published] }
  workflow_dispatch:
name: pkgdown-gh-pages
jobs:
  pkgdown:
    runs-on: ubuntu-latest
    env: { GITHUB_PAT: "${{ secrets.GITHUB_TOKEN }}" }
    permissions: { contents: write }
    steps:
      - uses: actions/checkout@v4
      - uses: r-lib/actions/setup-pandoc@v2
      - uses: r-lib/actions/setup-r@v2
        with: { use-public-rspm: true }
      - uses: r-lib/actions/setup-r-dependencies@v2
        with: { extra-packages: "any::pkgdown, local::.", needs: website }
      - run: pkgdown::build_site_github_pages(new_process = FALSE, install = FALSE)
        shell: Rscript {0}
      - uses: JamesIves/github-pages-deploy-action@v4
        with: { folder: docs, branch: gh-pages, clean: true }
```

Then in GitHub: Settings > Pages > Source: "Deploy from a branch" > Branch: gh-pages, folder: / (root).

### GitHub Actions Deployment (Alternative)

Replace the deploy step with Actions Pages integration: add `pages: write` and `id-token: write` permissions, then use `actions/configure-pages@v4`, `actions/upload-pages-artifact@v3` (path: docs), and `actions/deploy-pages@v4`. Set GitHub Pages source to "GitHub Actions" instead of a branch. Pick one method -- do not mix both.

### Verifying Deployment

```bash
gh run list --workflow=pkgdown-gh-pages
curl -I https://username.github.io/packagename/
```

## CRAN Submission

### Pre-Submission Checklist

```r
devtools::check()                # Local check (0 errors, 0 warnings, 0 notes)
devtools::check_win_devel()      # Win-builder devel
devtools::check_win_release()    # Win-builder release
rhub::rhub_check()               # R-hub multi-platform
devtools::spell_check()          # Spelling
urlchecker::url_check()          # URLs
```

### DESCRIPTION Requirements

```
Package: packagename
Title: What the Package Does (One Line, Title Case)
Version: 0.1.0
Authors@R:
    person("First", "Last", , "email@example.com", role = c("aut", "cre"),
           comment = c(ORCID = "YOUR-ORCID-ID"))
Description: What the package does (one paragraph).
License: MIT + file LICENSE
URL: https://github.com/username/packagename
BugReports: https://github.com/username/packagename/issues
```

Always use `::` for package-qualified calls. Never use `library()` or `require()` in package code.

See the [submit-to-cran](../skills/r-packages/submit-to-cran/SKILL.md) skill for the full procedure.

## CI/CD Setup

### R CMD Check Workflow

```yaml
# .github/workflows/R-CMD-check.yaml
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

name: R-CMD-check

jobs:
  R-CMD-check:
    runs-on: ${{ matrix.config.os }}
    strategy:
      matrix:
        config:
          - {os: windows-latest, r: 'release'}
          - {os: macOS-latest, r: 'release'}
          - {os: ubuntu-latest, r: 'release'}
          - {os: ubuntu-latest, r: 'devel'}
```

For renv in CI, add `r-lib/actions/setup-renv@v2`. See the [setup-github-actions-ci](../skills/r-packages/setup-github-actions-ci/SKILL.md) skill for complete configuration.

## Common Patterns

### S3 Methods

```r
#' @export
process <- function(x, ...) UseMethod("process")

#' @export
process.myclass <- function(x, ...) {
  # Implementation
}
```

### Package Data

```r
my_data <- data.frame(x = 1:10, y = letters[1:10])
usethis::use_data(my_data)
```

Document in `R/data.R`:

```r
#' Example dataset
#' @format A data frame with 10 rows and 2 variables:
#' \describe{
#'   \item{x}{numeric values}
#'   \item{y}{character values}
#' }
"my_data"
```

### Package Options and Error Handling

```r
# In R/zzz.R -- set package-level options
.onLoad <- function(libname, pkgname) {
  op <- options()
  op.pkg <- list(packagename.verbose = FALSE, packagename.max_iterations = 1000)
  toset <- !(names(op.pkg) %in% names(op))
  if (any(toset)) options(op.pkg[toset])
  invisible()
}

# Validate input with informative messages
if (!is.numeric(x)) stop("'x' must be numeric", call. = FALSE)
if (any(is.na(x))) {
  warning("NA values in 'x' will be removed", call. = FALSE)
  x <- x[!is.na(x)]
}
```

## Troubleshooting

### "no visible binding for global variable"

Use the `.data` pronoun or declare global variables:

```r
df %>% dplyr::filter(.data$column > 5)
# Or at package level: utils::globalVariables(c("column"))
```

### Missing Function Imports

Add `@importFrom` directives for functions like `n()`, `sd()`, `vars()`: `#' @importFrom dplyr filter group_by summarise n` and `#' @importFrom stats sd`.

### Examples Taking Too Long

Use `\donttest{}` (skipped during CHECK) or `\dontrun{}` (never runs automatically) around slow examples.

### Missing Pandoc

Set in `.Renviron` (git-ignored): `RSTUDIO_PANDOC="C:/Program Files/RStudio/resources/app/bin/quarto/bin/tools"`

### Platform-Specific Code

Use `.Platform$OS.type == "windows"` for conditionals. Use `testthat::skip_on_cran()` and `testthat::skip_on_os("windows")` in tests.

### pkgdown 404 After Deployment

1. **Development mode enabled** -- comment out `development: mode: auto` in `_pkgdown.yml`
2. **Pages source mismatch** -- branch deployment requires "Deploy from a branch"; Actions deployment requires "GitHub Actions"
3. **Missing permissions** -- ensure `contents: write` (plus `pages: write` and `id-token: write` for Actions)

### renv Installation Timeouts

Install packages individually: `for (pkg in pkgs) try(renv::install(pkg))` then `renv::snapshot(force = TRUE)`.

### renv Snapshot Validation Failures

Use `renv::dependencies()` to audit requirements, then `renv::snapshot(force = TRUE)` to bypass validation.

### Windows-Specific renv Issues

- Ensure R and Rtools are in PATH; use full paths if needed
- Shorten project directory names to avoid Windows path length limits
- Prefer binary packages: `renv::install("package", type = "binary")`

### Git Credential Issues for GitHub Packages

```r
usethis::create_github_token()
gitcreds::gitcreds_set()
```

## Related Resources

### Agents

- [r-developer](../agents/r-developer.md) -- primary agent for R package development
- [code-reviewer](../agents/code-reviewer.md) -- code quality and style review

### Teams

- [r-package-review](../teams/r-package-review.md) -- coordinated review of code, docs, security, and best practices

### Skills

- [create-r-package](../skills/r-packages/create-r-package/SKILL.md)
- [write-roxygen-docs](../skills/r-packages/write-roxygen-docs/SKILL.md)
- [write-testthat-tests](../skills/r-packages/write-testthat-tests/SKILL.md)
- [submit-to-cran](../skills/r-packages/submit-to-cran/SKILL.md)
- [build-pkgdown-site](../skills/r-packages/build-pkgdown-site/SKILL.md)
- [manage-renv-dependencies](../skills/r-packages/manage-renv-dependencies/SKILL.md)
- [setup-github-actions-ci](../skills/r-packages/setup-github-actions-ci/SKILL.md)

### External References

- [R Packages (2e)](https://r-pkgs.org/) by Hadley Wickham and Jenny Bryan
- [Writing R Extensions](https://cran.r-project.org/doc/manuals/r-release/R-exts.html)
- [renv documentation](https://rstudio.github.io/renv/)
- [pkgdown documentation](https://pkgdown.r-lib.org/)
- [tidyverse Style Guide](https://style.tidyverse.org/)
- [CRAN Policies](https://cran.r-project.org/web/packages/policies.html)
- [r-lib/actions examples](https://github.com/r-lib/actions/tree/v2/examples)
